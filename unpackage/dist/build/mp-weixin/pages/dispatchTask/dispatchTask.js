"use strict";const e=require("../../common/vendor.js"),a=require("../../api/index.js"),t=require("../../utils/token.js");if(!Array){(e.resolveComponent("uv-navbar")+e.resolveComponent("uv-image")+e.resolveComponent("uv-icon")+e.resolveComponent("uv-line")+e.resolveComponent("uv-form-item")+e.resolveComponent("uv-form")+e.resolveComponent("uv-button")+e.resolveComponent("uv-datetime-picker")+e.resolveComponent("my-drawer"))()}Math||((()=>"../../uni_modules/uv-navbar/components/uv-navbar/uv-navbar.js")+(()=>"../../uni_modules/uv-image/components/uv-image/uv-image.js")+(()=>"../../uni_modules/uv-icon/components/uv-icon/uv-icon.js")+(()=>"../../uni_modules/uv-line/components/uv-line/uv-line.js")+l+(()=>"../../uni_modules/uv-form/components/uv-form-item/uv-form-item.js")+r+o+i+n+(()=>"../../uni_modules/uv-form/components/uv-form/uv-form.js")+(()=>"../../uni_modules/uv-button/components/uv-button/uv-button.js")+(()=>"../../uni_modules/uv-datetime-picker/components/uv-datetime-picker/uv-datetime-picker.js")+(()=>"../../components/my-drawer/my-drawer.js"))();const r=()=>"./components/SelectCarType.js",o=()=>"./components/SelectPlate.js",l=()=>"./components/SelectCargo.js",n=()=>"./components/Remark.js",i=()=>"./components/Material.js",u={__name:"dispatchTask",setup(r){const o=e.ref();function l(){e.index.navigateBack()}e.onLoad((a=>{const t=e.getCurrentInstance().proxy.getOpenerEventChannel();o.value=t,t.on("setData",(e=>{console.log("setData",e),n.value=e.supply,i.value=e.unload,I.CarType=e.carType,e.supply&&O()}))}));const n=e.ref(null),i=e.ref(null);function u(a){e.index.navigateTo({url:"/pages/selectAddress/selectAddress",success(e){e.eventChannel.emit("setData",{type:a,data:1===a?n.value:i.value})},events:{confirm(e){console.log("confirm",e),1===e.type&&(n.value=e.data,I.OwnerId="",O()),2===e.type&&(i.value=e.data)}}})}const s=e.ref(),v=e.ref("start"),d=e.ref(""),m=e.ref(""),p=e.dayjs().valueOf(),c=e.dayjs().add(1,"year").valueOf(),g=e.ref(),f=e.ref();function h(e,a){return"year"===e?`${a}年`:"month"===e?`${a}月`:"day"===e?`${a}日`:"hour"===e?`${a}时`:"minute"===e?`${a}分`:a}function y(a){v.value=a,"start"===a&&(g.value=p,f.value=m.value?e.dayjs(m.value).valueOf():c),"end"===a&&(g.value=d.value?e.dayjs(d.value).valueOf():p,f.value=c),s.value.open()}function x(e){"start"===e&&(d.value=""),"end"===e&&(m.value="")}function w({value:a}){console.log("value",a,e.dayjs(a).format("YYYY-MM-DD HH:mm")),"start"===v.value&&(d.value=a),"end"===v.value&&(m.value=a)}const I=e.reactive({OwnerId:"",CarType:[],Carno:[],Memo:""}),S=e.ref({OwnerId:[{type:"string",required:!0,message:"请选择货主公司",trigger:["blur","change"]}]}),M=e.ref([]);async function O(){var e;if(!n.value.Id)return;const t=await a.GetOwnerBySupply({supplyId:n.value.Id,qType:1});M.value=t.map((e=>({value:e.Id,label:e.Ownername}))),1===t.length&&(I.OwnerId=(null==(e=null==t?void 0:t[0])?void 0:e.Id)??"",B())}const C=e.computed((()=>{var e;return!(null==(e=n.value)?void 0:e.Id)}));function L(){e.index.showToast({title:"请先选择装货地",icon:"none"})}function T(e){b.value=null,k.value=[],B()}const j=e.ref(),b=e.ref(),k=e.ref([]);async function B(){const e=(await a.GetOwnerOrderList({supplyId:n.value.Id,ownerId:I.OwnerId})).map((e=>{var a;return{...e,MaterialsList:(null==(a=e.MaterialsList)?void 0:a.map((e=>({...e,Limittype:"0",EstimiteWeight:e.minWgtLeft}))))??[]}}));k.value=e,1===e.length&&(b.value=(null==e?void 0:e[0])??null)}function F(){k.value.length<=1||j.value.popup.open()}const D=e.computed((()=>{let a=e.Big(0).toFixed(2);if(!b.value)return a;if(!b.value.MaterialsList||b.value.MaterialsList&&0===b.value.MaterialsList.length)return a;const t=b.value.MaterialsList.map((t=>{const{TaxPrice:r,Limittype:o,EstimiteWeight:l,EstimiteTimes:n}=t,i=b.value.SingleWeight;return"0"===o&&(a=e.Big(0).toFixed(2)),"1"===o&&(a=e.Big(l||0).times(r||0).toFixed(2)),"2"===o&&(a=e.Big(n||0).times(i||0).times(r||0).toFixed(2)),console.log("price",a),a})).reduce(((a,t)=>e.Big(a).plus(t).toFixed(2)),0);return console.log("total",t,b.value.MaterialsList),t})),E=e.computed((()=>{if(!b.value)return!1;const a=e.Big(b.value.AlertBalance||0);return e.Big(b.value.Balance||0).plus(b.value.CreditBalance||0).minus(D.value).lt(a)})),Y=e.ref(!1);async function H(){var r,o;if(console.log("order",b.value),!n.value)return void e.index.showToast({title:"请选择装货地",icon:"none"});if(!i.value)return void e.index.showToast({title:"请选择卸货地",icon:"none"});if(!I.OwnerId)return void e.index.showToast({title:"请选择货主公司",icon:"none"});if(!b.value)return void e.index.showToast({title:"请选择订单",icon:"none"});const l={Supply:n.value.Id,OwnerId:I.OwnerId,UnloadPlaceId:i.value.Id,Orderid:b.value.SSOrderId,Orderno:b.value.SSOrderNo,StartTime:d.value?e.dayjs(d.value).format("YYYY-MM-DD HH:mm"):"",EndTime:m.value?e.dayjs(m.value).format("YYYY-MM-DD HH:mm"):"",Carno:I.Carno.join(","),CarType:I.CarType.join(","),MatList:b.value.MaterialsList.map((e=>{const a={Material:e.SSMaterialId,Materialname:e.SSMaterialName,Limittype:e.Limittype,LeftWeight:e.WeightLeft,EstimatePrice:e.TaxPrice};return"1"===e.Limittype&&(a.EstimiteWeight=e.EstimiteWeight),"2"===e.Limittype&&(a.EstimiteTimes=e.EstimiteTimes),a})),Memo:I.Memo,OwnerUserId:(null==(o=null==(r=t.getToken())?void 0:r.userInfo)?void 0:o.Id)??""};console.log("params",l);try{Y.value=!0,await a.SetAssignTicket(l),e.index.showToast({title:"派单成功！",icon:"none"}),e.index.navigateBack()}catch(u){e.index.showToast({title:u.data,icon:"none"})}finally{Y.value=!1}}return(a,t)=>e.e({a:e.o(l),b:e.p({title:"确认派单信息","bg-color":"transparent","title-style":{color:"#FFFFFF"},leftIconColor:"#FFFFFF",placeholder:!0}),c:n.value},n.value?{d:e.t(n.value.Name),e:e.t(n.value.Linker),f:e.t(n.value.LinkerMobile)}:{},{g:e.o((e=>u(1))),h:e.p({src:"/static/images/arrow.png",duration:0,width:"24rpx",height:"24rpx"}),i:i.value},i.value?{j:e.t(i.value.Placename),k:e.t(i.value.Nickname),l:e.t(i.value.Mobile)}:{},{m:e.o((e=>u(2))),n:e.p({src:"/static/images/arrow.png",duration:0,width:"24rpx",height:"24rpx"}),o:e.p({src:"/static/images/dispatchTask/clock.png",width:"36rpx",height:"36rpx",duration:0,"custom-style":{marginRight:"24rpx"}}),p:d.value},d.value?{q:e.t(e.unref(e.dayjs)(d.value).format("MM-DD HH:mm")),r:e.o((e=>x("start"))),s:e.p({name:"close",size:"12",color:"var(--intr-color)","custom-style":{marginLeft:"18rpx"}}),t:e.o((()=>{}))}:{v:e.p({src:"/static/images/arrow.png",duration:0,width:"24rpx",height:"24rpx","custom-style":{marginLeft:"6rpx"}})},{w:e.o((e=>y("start"))),x:e.p({direction:"col",length:"24rpx",color:"#B0BECC",margin:"0 20rpx"}),y:m.value},m.value?{z:e.t(e.unref(e.dayjs)(m.value).format("MM-DD HH:mm")),A:e.o((e=>x("end"))),B:e.p({name:"close",size:"12",color:"var(--intr-color)","custom-style":{marginLeft:"18rpx"}}),C:e.o((()=>{}))}:{D:e.p({src:"/static/images/arrow.png",duration:0,width:"24rpx",height:"24rpx","custom-style":{marginLeft:"6rpx"}})},{E:e.o((e=>y("end"))),F:e.o(L),G:e.o(T),H:e.o((e=>I.OwnerId=e)),I:e.p({options:M.value,disabled:C.value,modelValue:I.OwnerId}),J:e.p({label:"货主公司"}),K:e.o((e=>I.CarType=e)),L:e.p({modelValue:I.CarType}),M:e.p({label:"车辆类型限制",prop:"CarType"}),N:e.o((e=>I.Carno=e)),O:e.p({modelValue:I.Carno}),P:e.p({label:"车牌限制",prop:"Carno"}),Q:b.value},b.value?e.e({R:e.t(b.value.SSOrderNo),S:k.value.length>1},k.value.length>1?{T:e.p({src:"/static/images/arrow.png",duration:0,width:"24rpx",height:"24rpx","custom-style":{marginLeft:"6rpx"}})}:{},{U:e.o(F)}):{},{V:!(n.value&&I.OwnerId)},n.value&&I.OwnerId?0===k.value.length?{}:b.value?{aa:e.f(b.value.MaterialsList,((a,t,r)=>({a:a.SSMaterialId,b:"1988e7d6-19-"+r+",1988e7d6-17",c:e.o((e=>b.value.MaterialsList[t]=e),a.SSMaterialId),d:e.p({borderBottom:t<b.value.MaterialsList.length-1,order:b.value,modelValue:b.value.MaterialsList[t]})})))}:{Y:e.p({src:"/static/images/dispatchTask/arrow2.png",duration:0,width:"16rpx",height:"16rpx"}),Z:e.o(F)}:{},{W:0===k.value.length,X:!b.value,ab:e.p({prop:"material",labelPosition:"top"}),ac:e.o((e=>I.Memo=e)),ad:e.p({modelValue:I.Memo}),ae:e.p({label:"备注",prop:"Memo"}),af:e.sr("form","1988e7d6-9"),ag:e.p({labelPosition:"left",model:I,rules:S.value,"label-width":"200rpx"}),ah:e.t(D.value),ai:e.t(b.value?b.value.Balance?b.value.Balance:0:"-"),aj:e.o(H),ak:e.p({loading:Y.value,text:"确认派单",color:"linear-gradient( 270deg, #31CE57 0%, #07B130 100%)",customStyle:{height:"96rpx"}}),al:E.value},(E.value,{}),{am:e.sr(s,"1988e7d6-23",{k:"datetimePicker"}),an:e.o(w),ao:e.o((e=>a.value=e)),ap:e.p({mode:"datetime",confirmColor:"var(--main-color)",formatter:h,maxDate:f.value,minDate:g.value,modelValue:a.value}),aq:e.f(k.value,((a,t,r)=>e.e({a:e.t(a.SSOrderNo),b:b.value&&b.value.SSOrderId===a.SSOrderId},b.value&&b.value.SSOrderId===a.SSOrderId?{c:"1988e7d6-25-"+r+",1988e7d6-24",d:e.p({src:"/static/images/check.png",duration:0,width:"32rpx",height:"32rpx"})}:{},{e:b.value&&b.value.SSOrderId===a.SSOrderId?1:"",f:a.SSOrderId,g:e.o((e=>function(e){b.value=e,j.value.popup.close()}(a)),a.SSOrderId)}))),ar:e.sr(j,"1988e7d6-24",{k:"orderDrawer"}),as:e.p({title:"选择订单"})})}};wx.createPage(u);
